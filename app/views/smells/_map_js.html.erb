<script>
 // Load on page ready...
 $(document).ready(function(){
     var map;
     // define function to get user location
     function getLocation() {
         if (navigator.geolocation) {
             navigator.geolocation.getCurrentPosition(parsePosition);
         }
         // TODO: Add fall-back if user doesn't give location
     }

     // define callback for getCurrentPosition function of getLocation()
     function parsePosition(position) {
         var latitude = position.coords.latitude;
         var longitude = position.coords.longitude;
         insertMap(latitude, longitude);
     }

     // Define a function that inserts a map in 'map_canvas' at the user's location
     function insertMap(latitude, longitude) {
         var mapCanvas = document.getElementById('map-canvas');
         var mapOptions = {
             center: new google.maps.LatLng(latitude, longitude),
             zoom: 8,
             mapTypeId: google.maps.MapTypeId.ROADMAP
         }
         map = new google.maps.Map(mapCanvas, mapOptions);
         <% myArray = smells.map do |smell| %>
         <% [smell.lat, smell.lng] %>
         <% end %>
         var locations = <%= myArray %>;
         var marker, i;
         for (i = 0; i < locations.length; i++) {
             marker = new google.maps.Marker({
                 position: new google.maps.LatLng(locations[i][0], locations[i][1]),
                 map: map
             });
         };
     };

     function addMarker(smell) {
         marker = new google.maps.Marker({
             position: new google.maps.LatLng(smell.lat, smell.lng),
             map: map
         });
     }

     // Initialize map
     getLocation();

     // Connect to websocket
     var dispatcher = new WebSocketRails('www.itsmellshere.com/websocket');
     var channel = dispatcher.subscribe('smells');
     channel.bind('new', function(smell) {
         // Add marker when smell added to database
         addMarker(smell);
     });
 });
</script>
